<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>3D –°—Ü–µ–Ω–∞ —Å –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π –°–µ—Ç–∫–æ–π</title>
    <style>
        body {
            overflow: hidden;
            margin: 0;
            background: #000;
            font-family: sans-serif;
        }
        #scene-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* –î–æ–±–∞–≤—å—Ç–µ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π CSS */
        #object-controls {
            position: absolute;
            bottom: 400px;
            left: 20px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 5px;
            z-index: 100;
            min-width: 280px;
            max-height: 500px;
            overflow-y: auto;
            font-size: 11px;
        }

        .object-types {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin: 8px 0;
        }

        .object-type-btn {
            background: #333;
            padding: 6px;
            border-radius: 3px;
            text-align: center;
            cursor: pointer;
            font-size: 10px;
            border: 1px solid #555;
        }

        .object-type-btn.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .object-type-btn:hover {
            background: #444;
        }

        .object-type-btn.active:hover {
            background: #45a049;
        }

        .control-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 6px 10px;
            margin: 3px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            width: calc(100% - 6px);
        }

        .control-btn:hover {
            background: #1976D2;
        }

        .object-list {
            max-height: 100px;
            overflow-y: auto;
            margin: 8px 0;
            padding: 5px;
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
            font-size: 9px;
        }

        input[type="file"] {
            background: rgba(255,255,255,0.1);
            border: 1px solid #555;
            border-radius: 3px;
            color: white;
            padding: 4px;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 5px;
            z-index: 100;
            font-size: 12px;
            line-height: 1.4;
            max-width: 300px;
        }
        #cameraInfo {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 5px;
            z-index: 100;
            font-size: 12px;
            line-height: 1.4;
        }
        .value {
            color: #4CAF50;
            font-weight: bold;
        }
        #back-button {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: 2px solid #4CAF50;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100;
            font-size: 14px;
        }
        #back-button:hover {
            background: rgba(76, 175, 80, 0.3);
        }
        #grid-controls {
            position: absolute;
            bottom: 80px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 5px;
            z-index: 100;
            min-width: 250px;
        }
        .grid-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 12px;
            margin: 3px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        .grid-btn:hover {
            background: #1976D2;
        }
        .slider-container {
            margin: 8px 0;
        }
        .slider-label {
            display: block;
            font-size: 10px;
            margin-bottom: 4px;
            color: #ccc;
        }
        input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }
        .grid-value {
            font-size: 10px;
            color: #4CAF50;
            float: right;
        }
        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 8px 0;
        }
        .color-btn {
            width: 20px;
            height: 20px;
            border: 2px solid white;
            border-radius: 3px;
            cursor: pointer;
        }
        .color-btn.active {
            border-color: yellow;
            transform: scale(1.2);
        }
        .export-info {
            font-size: 9px;
            color: #ccc;
            margin-top: 5px;
            line-height: 1.2;
        }
    </style>
</head>
<body>
<div id="scene-container"></div>
<div id="info">–ó–∞–≥—Ä—É–∑–∫–∞ 3D —Å—Ü–µ–Ω—ã...</div>
<div id="cameraInfo">
    <div>üé• –ö–ê–ú–ï–†–ê –ó–ê–§–ò–ö–°–ò–†–û–í–ê–ù–ê</div>
    <div>–ü–æ–∑–∏—Ü–∏—è: <span class="value">X:-0.35 Y:6.90 Z:7.4</span></div>
    <div>–°–µ—Ç–∫–∞: <span class="value" id="gridStatus">–ê–∫—Ç–∏–≤–Ω–∞</span></div>
    <div>–†–µ–∂–∏–º: <span class="value" id="paintMode">–ü–æ–∫—Ä–∞—Å–∫–∞</span></div>
</div>
<div id="grid-controls">
    <div>üó∫Ô∏è –†–ï–î–ê–ö–¢–û–† –°–ï–¢–ö–ò:</div>

    <div class="slider-container">
        <span class="slider-label">–í—ã—Å–æ—Ç–∞ —Å–µ—Ç–∫–∏: <span class="grid-value" id="heightValue">0.0</span></span>
        <input type="range" id="heightSlider" min="-10" max="10" step="0.1" value="0">
    </div>

    <div class="slider-container">
        <span class="slider-label">–†–∞–∑–º–µ—Ä —Å–µ—Ç–∫–∏: <span class="grid-value" id="sizeValue">20</span></span>
        <input type="range" id="sizeSlider" min="5" max="50" step="5" value="20">
    </div>

    <div class="color-palette">
        <div class="color-btn active" style="background:#00ff00" data-color="0x00ff00" data-type="walkable"></div>
        <div class="color-btn" style="background:#ff0000" data-color="0xff0000" data-type="blocked"></div>
        <div class="color-btn" style="background:#0000ff" data-color="0x0000ff" data-type="water"></div>
        <div class="color-btn" style="background:#ffff00" data-color="0xffff00" data-type="danger"></div>
        <div class="color-btn" style="background:#ff00ff" data-color="0xff00ff" data-type="special"></div>
        <div class="color-btn" style="background:#888888" data-color="0x888888" data-type="erase"></div>
    </div>

    <div class="slider-container">
        <span class="slider-label">–ö–∏—Å—Ç—å: <span class="grid-value" id="brushSize">1x1</span></span>
        <input type="range" id="brushSlider" min="1" max="3" step="1" value="1">
    </div>

    <button class="grid-btn" id="toggle-grid">–°–µ—Ç–∫–∞ –í–ö–õ/–í–´–ö–õ</button>
    <button class="grid-btn" id="paint-mode">–†–µ–∂–∏–º: –ü–æ–∫—Ä–∞—Å–∫–∞</button>
    <button class="grid-btn" id="clear-paint">–û—á–∏—Å—Ç–∏—Ç—å –∫—Ä–∞—Å–∫—É</button>
    <button class="grid-btn" id="export-grid">–≠–∫—Å–ø–æ—Ä—Ç —Å–µ—Ç–∫–∏</button>
    <button class="grid-btn" id="import-grid">–ò–º–ø–æ—Ä—Ç —Å–µ—Ç–∫–∏</button>

    <div class="export-info">
        –õ–ö–ú - –∫—Ä–∞—Å–∏—Ç—å —è—á–µ–π–∫—É<br>
        –ü–ö–ú - —É–¥–∞–ª–∏—Ç—å –∫—Ä–∞—Å–∫—É<br>
        –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –ò–ò –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    </div>
</div>
<button id="back-button">‚Üê –ù–∞–∑–∞–¥</button>

<!-- Three.js –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º—É —Å–µ—Ç–∫–∏ –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–∞–ø–∫–∏ -->
<script src="../scripts/grid-system.js"></script>
<script src="../scripts/grid-ui.js"></script>

<script src="../scripts/object-behaviors.js"></script>
<script src="../scripts/object-configs.js"></script>
<script src="../scripts/object-manager.js"></script>
<script src="../scripts/object-ui-export.js"></script>
<script src="../scripts/character-walk.js"></script>
<script src="../scripts/object-placer.js"></script>
<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Three.js —Å—Ü–µ–Ω—ã
    function initScene() {
        const container = document.getElementById('scene-container');
        let scene = new THREE.Scene();
        let camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(-0.35, 6.90, 7.4);
        camera.rotation.x = -36.5 * Math.PI / 180;
        camera.rotation.y = 0;
        camera.rotation.z = 0;

        let renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setClearColor(0x404040);
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        // –û—Å–≤–µ—â–µ–Ω–∏–µ
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
        directionalLight.position.set(5, 10, 7);
        scene.add(directionalLight);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        // ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É —Å–µ—Ç–∫–∏ –∏–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        const gridSystem = new GridSystem(scene, camera, renderer);

        // ‚úÖ –í–ê–ñ–ù–û: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º UI –¥–ª—è —Å–µ—Ç–∫–∏
        const gridUI = new GridUI(gridSystem);

        // ‚úÖ –î–û–ë–ê–í–¨–¢–ï: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º ObjectPlacer
        const objectPlacer = new ObjectPlacer(scene, gridSystem, camera, renderer);

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å)
        let loader = new THREE.GLTFLoader();
        loader.load('none.gltf',
            function(gltf) {
                while(scene.children.length > 0) scene.remove(scene.children[0]);
                scene.add(directionalLight);
                scene.add(ambientLight);

                let obj = gltf.scene;
                scene.add(obj);

                const bbox = new THREE.Box3().setFromObject(obj);
                const center = bbox.getCenter(new THREE.Vector3());
                const size = bbox.getSize(new THREE.Vector3());

                document.getElementById('info').innerHTML =
                    `‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞!<br>
                     üìê –†–∞–∑–º–µ—Ä: ${size.x.toFixed(2)} x ${size.y.toFixed(2)} x ${size.z.toFixed(2)}<br>
                     üé® –†–µ–¥–∞–∫—Ç–æ—Ä —Å–µ—Ç–∫–∏ –≥–æ—Ç–æ–≤<br>
                     üèóÔ∏è –†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ<br>
                     –õ–ö–ú - –∫—Ä–∞—Å–∏—Ç—å/—Ä–∞–∑–º–µ—â–∞—Ç—å, –ü–ö–ú - —Å—Ç–∏—Ä–∞—Ç—å/—É–¥–∞–ª—è—Ç—å`;

                camera.lookAt(center);
            },
            null,
            function(error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
                document.getElementById('info').innerHTML =
                    `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏!<br>–†–µ–¥–∞–∫—Ç–æ—Ä —Å–µ—Ç–∫–∏ –∞–∫—Ç–∏–≤–µ–Ω<br>üèóÔ∏è –†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ`;

                const geometry = new THREE.BoxGeometry(2, 2, 2);
                const material = new THREE.MeshPhongMaterial({ color: 0x00ff00 });
                const cube = new THREE.Mesh(geometry, material);
                scene.add(cube);
            }
        );

        // –ê–Ω–∏–º–∞—Ü–∏—è
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
        document.getElementById('back-button').addEventListener('click', function() {
            const blackOverlay = document.createElement('div');
            blackOverlay.style.position = 'absolute';
            blackOverlay.style.left = '0';
            blackOverlay.style.top = '0';
            blackOverlay.style.width = '100%';
            blackOverlay.style.height = '100%';
            blackOverlay.style.backgroundColor = '#000';
            blackOverlay.style.opacity = '0';
            blackOverlay.style.transition = 'opacity 0.7s ease';
            blackOverlay.style.zIndex = '10000';
            document.body.appendChild(blackOverlay);

            requestAnimationFrame(() => {
                blackOverlay.style.opacity = '1';
            });

            setTimeout(() => {
                window.location.reload();
            }, 700);
        });
    }

    document.addEventListener('DOMContentLoaded', initScene);
</script>
</body>
</html>